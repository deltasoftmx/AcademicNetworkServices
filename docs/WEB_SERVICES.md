# Web services documentation

## Index
* [General information](#general-information)
  * [Response data structure](#response-data-structure)
  * [Mandatory headers](#mandatory-headers)
  * [Codes](#codes)
    * [General codes](#general-codes)
    * [Fatal error codes](#fatal-error-codes)
* [Social Network API](#social-network-api)
  * [Users](#users)
    * [Create student](#create-student)
    * [Sign in](#sign-in)
    * [Get public user data](#get-public-user-data)
    * [Create post](#create-post)
    * [Search users](#search-users)
    * [Get public user types](#get-public-user-types)
    * [Get majors data](#get-majors-data)
  * [Groups](#groups)
    * [Get permission of a group](#get-permission-of-a-group)
    * [Search groups](#search-groups)
    * [Create a group](#create-a-group)
    * [Switch group notifications](#switch-group-notifications)
    * [Update group image](#update-group-image)

## General information

### Response data structure

```json
{
  "code": 0,
  "data": { },
  "messages": [ ]
}
```

* `code`: The exit code of the process. Helpfully to see what exactly happened.
* `data`: The data requested, or the data returned when the execution was correct.
* `messages`: A message array to help the programmer to identify easier what happened with the process.

### Mandatory headers
* **Content-Type**: application/json
* **x-api-key**: [Hash provided by server maintainer]
* **Authorization**: [JWT generated by a call to the signin endpoint of Social Network API]

Authorization header is not always required but it is at most of endpoints. Where it is required will be
mentioned on headers section of the endpoint description. This header is used to authenticate the user
that requests an endpoint.

### Codes

Following codes are common in all endpoints of the **Social Network API** and the **Administration API**.

#### General codes

The kind of codes are negative numbers. They represents errors with the data provided by the client. They DO NOT
represent an invalid combination of data, but a invalid data type, a missing argument, an unauthorized use of the API
or in a special case, an unknown error.

* 0: Success.
* -1: Params are not corrects.
* -2: User token expired.
* -3: User authentication (token) not valid.
* -4: Application not allowed to use the service.
* -5: An unknown error. Check log/crash_reports.log and API log files to see what happened.

#### Fatal error codes

These are server-side errors and must be addressed as soon as possible. If they happen, application keep
working but some important features are not going to work.

* 1000: RSA keys were not found when trying to sign o verify a token.
  * What to do: You need to put the RSA key pair in their right place. Read the [documentation of how to setup the environment](ENV_SETUP.md)
  and read the RSA certs section.

* 1001: Cloudinary credentials were not found when trying to use endpoints which use Cloudinary services.
  * What to do: You need to set the Cloudinary credentials in the .env file. There are two options:
      * Doing manually, read the section Setting up environment variables in the [documentation of how to setup the environment](ENV_SETUP.md). 
      * Using the script for setup the enviroment and add the cloudinary flag options. You can find more info in the [scripts documentation](SCRIPTS.md) in the section Setup environment.

## Social Network API

### Users

#### Create student

##### Description

Create a new student user in the system and return a session token.

##### Endpoint
`/v1/api/social-network/users/signup`

##### Headers

Not more than the mandatories.

##### Method

POST

##### Params

* `firstname`: string
* `lastname`: string
* `email`: string
* `passwd`: string
* `description`: string
* `user_type_id`: int
* `major_id`: int

##### Response data-structure

```json
{
  "session_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjo0LCJpYXQiOjE1OTY3NjYzOTcsImV4cCI6MTU5NzM3MTE5N30.AAuRetvF60kCqMYjUatkvhVKu75WHBGiYAv3K-yw5LOk-WIAWVlwmaXEzC5VVVYlHs3VfteCT52LFpkJSdQPsaCalEmngOx2tqshfwtK7PolRQN7j_Qcvqh-ckhwyPW_oVux5OjBqbbq9XYg3y5uhHpkNur9ouOFbMdPYx95YWp_gR0KfI5n8j7xjOyNLvNEg7X4wxHh7k-APWY8kt9rPTHaOxjUBsBKS-Uf3G4qoWQ1mqqRawH9YkpmNzmqjfj_hnV-Plvl-pAzc5fznkAYWiSFFQtyAPS5r7hAK2uzNxPT38q-Eo_YghukfLhqbPZyCutIf5HDy3VJnAJ2CSLLonAr9_uXqtTizyg4ijv61sFz30HfnbxZ5lsllJm2rggTNQm7XafQNjG1L1uukjLKtO39a-BA1RPZQuv0vnXCihArFdY1NNMCyL4eUehNxlDWj56VyLIq_DqIFtdXHKiuoqEFq7Mr4gkYQI4Qu3hshbjxrD1y_ELJnE44D4qbdVdK"
}
```

##### Codes
* 1: Domain name not allowed.
* 2: Email already exists.
* 3: Username already exists.
* 4: User type doesn't exists.
* 5: Major doesn't exists.
* 6: Student id already exists.

#### Sign in

##### Description

Generates a session token to be used by an user. This token must be sent in the `Authorization` header
of a request that calls to an endpoint that requires user authentication.

##### Endpoint
`/v1/api/social-network/users/signin`

##### Headers

Not more than the mandatories.

##### Method

POST

##### Params

* `username`: string. It can be the username or email.
* `passwd`: string

##### Response data-structure

```json
{
  "session_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyX2lkIjp7ImlkIjoyMH0sImlhdCI6MTU5NTA1MzM5NSwiZXhwIjoxNTk1NjU4MTk1fQ.n39rxTNk6z64hIAh4BmJLucIjawBN0UGuU_IyVgCBa2vkzqsRhntU8YHQXMkmpZyzZTDWlowFSMfaNWOXthcK0O2U5gxKtXB-suRoEOijZu03c7B3BnIBZt4lid7KBhi3WME_JUJIV3xVQQiy-XIW0qMSsG3dJyHDB-jLAv1YL9vrGZdIobsAD0cipUyBrRfez4N824-EtlLjxyHHjsnmGeMMqhebIL3Lkgb-OaHDzqVgEcULRqqXozuGXHYw4a5Qs41eIF2q7zrq1DQueXGuNG-NKnB8gP8Hx_0Z_zT0syI6tfCyfFtF11-BAL7fEOOIBjsRW7grifqbZ3x8OXRiVdRewydvLHDqUqY5B4EdJEAK-q3WvxiolXZ-obYGY48enMuM4kLvrSL19Uu-NYbRk5Q3INoSecIsr2s_Kp2Ac8d-4gYjzCLyad8cmhXRZP8kzLVfdx6wpWvcG5vJB1YVa1rqms-ldsecZNhsTE5eqcv7TDxrSMJPR11RTqDx-DK"
}
```

##### Codes

* 1: Invalid credentials.

#### Get public user data

##### Description

Retrieve the user public information according of the user type. For example, if the user is a student
so within the data will be the major and the email will not show.

##### Endpoint

`/v1/api/social-network/users/data/:username`

##### Headers

Not more than the mandatories.

##### Method

GET

##### Params

* `username`: string.

##### Response data-structure

```json
{
  "username": "jonhdoe",
  "firstname": "John",
  "lastname": "Doe",
  "type_user": "Estudiante",
  "description": "Hi I'm John Doe",
  "profile_img_src": "",
  "created_at": "2020-07-20T16:31:31.000Z",
  "major": "Data Engineering"
}
```

##### Codes
* 1: Username doesn't exists.

#### Create post

##### Description

Create a new user post, either only text or text with an image.

##### Endpoint

`/v1/api/social-network/users/post`

##### Headers

* `Content-Type`: multipart/form-data
* `Authorization`

##### Method

POST

##### Params

* `content`: string.
* `image`: Object.

##### Response data-structure

```json
{
  "content": "Lorem ipsum",
  "img_src": "https://res.cloudinary.com/user-cloud/image/upload/v123123123/adfadfa2sf3hr4sth4w.jpg",
}
```

##### Codes
* 1: No data was sent.

#### Search users

##### Description

Performs a search of a certain relative kind of user, based on the user that ask for the search. It can retrieve 
all of users, followers or users followed by the requesting user that match with a search criteria. If the search 
field is empty, the records are not discriminated. Records are served into groups of a certain size called pages. 
You can select the group size and what group get in a call.

This endpoint also return how much records were found with the search criteria.

##### Endpoint

`/v1/api/social-network/users/search`

##### Headers

* `Authorization`

##### Method

GET

##### Params

All of the following parameters are optional. It has default values.

* `user_relative_type`: string.

This parameter set what relative type of user to search for. It can be all kind of users (`all`), followers of the user
(`followers`) or the users that the user follow (`followed`). Default `all`.

* `offset`: int.

The size of the group of records to retrieve. Default `10`.

* `page`: int.

The number of the group to retrieve. Pages starts at `0`, what is also the default value.

* `search`: string.

A phrase containing keywords to perform the search. Default is an empty string.

* `asc`: int.

If records are retrieved in ascending order. Default `1`. Use `0` for false.

##### Response data-structure

```json
{
  "users": [
    {
      "username": "person 4",
      "firstname": "person 4 firstname",
      "lastname": "person 4 lastname",
      "profile_img_src": ""
    },
    {
      "username": "person 3",
      "firstname": "person 3 firstname",
      "lastname": "person 3 lastname",
      "profile_img_src": ""
    }
  ],
  "total_records": 4
}
```

##### Codes

No particular codes.

#### Get public user types

##### Description

Return an object containing an array of names and ids of the public user types. Useful as part of the sign up flow.

##### Endpoint

`/v1/api/social-network/users/types`

##### Headers

Not more than madatories.

##### Method

GET

##### Params

Void

##### Response data-structure

```json
{
  "user_types": [
    {
      "name": "Estudiante",
      "id": 1
    },
    {
      "name": "Invitado",
      "id": 3
    }
  ]
}
```

##### Codes

No particular codes.

#### Get majors data

##### Description

Return an object containing an array of names and ids of avaliable majors. Useful as part of the sign up flow.

##### Endpoint

`/v1/api/social-network/users/majors`

##### Headers

Not more than madatories.

##### Method

GET

##### Params

Void

##### Response data-structure

```json
{
  "majors": [
    {
      "id": 1,
      "name": "Data Engineering"
    },
    {
      "id": 2,
      "name": "Environmental Engineering"
    }
  ]
}
```

##### Codes

No particular codes.

### Groups

#### Get permission of a group

##### Description

Return the permissions that a group has.

##### Endpoint

`/v1/api/social-network/groups/group/:group_id/permissions`

##### Headers

Not more than madatories.

##### Method

GET

##### Params

* `group_id`: the id of the group to request. Replace this label by the id in the url.

##### Response data-structure

```json
{
  "permissions": [
    {
      "name": "Allow publications",
      "codename": "allow_posts"
    }
  ]
}
```

##### Codes

1. Group doesn't exists. 

#### Search Groups

##### Description

Performs a search of certain relative kind of group, based on the user that ask for the search. It can retrieve all the public 
groups or only the groups (public and private) that user belongs to, that match with a search criteria. If the search field is 
empty the records are not discriminated. Records are served in groups of a certain size (determined by offset) called pages. You 
can select the offset size and what page get in a call.
This endpoint also return how much records were found with the search criteria.

##### Endpoint

`/v1/api/social-network/groups/search`

##### Headers

* `Authorization`

##### Method

GET

##### Params

All the following parameters are optional. It has default values.

* `group_relative_type`:

This parameter set what relative type of group to search for. It can be all kind of groups (`all`) or the groups that user belongs 
to (`user`). Default (`all`).

* `search`:

A phrase containing keywords to perform the search. The keywords are related to the name, description and tags of the group. 
Default is an empty string.

* `offset`:

The size of the group of records to retrieve. Default `10`.

* `page`:

The number of the group of records to retrieve. Page start at `0`, what is also the default value.

* `asc`:

If the records are retrieved in ascending order. Default `1`. Use `0` for false.


##### Response data-structure

```json
{
  "groups": [
    {
      "id": 4,
      "name": "Group 4",
      "image_src": "",
      "description": "This is the Group 4"
    },
    {
      "id": 3,
      "name": "Group 3",
      "image_src": "",
      "description": "This is the Group 3"
    }
  ],
  "total_records": 4
}
```

##### Codes

No particular codes.

#### Create a group

##### Description

Creates a new group associating the requesting user as owner.

##### Endpoint

`/v1/api/social-network/groups/create`

##### Headers

* Authorization

##### Method

POST

##### Params

* `group_name`: string. The name of the group. 
* `description`: string. Group description, optional.
* `visibility`: string. If public or private. Posible values [`public`|`private`]
* `permissions`: Array\<int>. An array of permission ids. See [here](#) to request available permissions.
* `tags`: Array\<string>. An array of strings representing tags that will be used to appear in searches.

##### Response data-structure

```json
{
  "group_id": 8
}
```

##### Codes

1. User owner does not exists.
2. Visibility not allowed.
3. Permission does not exists

#### Switch group notifications

##### Description

Turn on or turn off the group notifications.

##### Endpoint

`/v1/api/social-network/groups/group/:group_id/switch-notifications`

##### Headers

* `Authorization`

##### Method

PUT

##### Params

* `group_id`: int.

The id of the group to request. Replace this label by the id in the url.

* `state`: int.

New state of the group notifications. Use `0` to turn off or `1` to turn on the notifications.

##### Response data-structure

No particular response data-structure.

##### Codes

1. User doesn't exist in the group memberships or the group doesn't exist.
2. Group notifications are already in that state.

#### Update group image

##### Description

Update the group image. To do that the user requesting must be the group owner.

##### Endpoint

`/v1/api/social-network/groups/group/:group_id/update-image`

##### Headers

* `Content-Type`: multipart/form-data
* `Authorization`

##### Method

PUT

##### Params

* `group_id`: int. The id of the group to request. Replace this label by the id in the url.
* `image`: Object. The new image for the group.

##### Response data-structure

```json
{
  "image_src": "https://res.cloudinary.com/user-cloud/image/upload/v123123123/adfadfa2sf3hr4sth4w.jpg"
}
```

##### Codes

1. The group does not exist.
2. Permission denied. You are not the group owner.